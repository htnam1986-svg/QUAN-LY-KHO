<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT ERP - Master Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style id="main-font-style">
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono&family=Be+Vietnam+Pro:wght@300;400;700&display=swap');
        :root { --font-main: 'Inter', sans-serif; }
        body { font-family: var(--font-main); background-color: #f8fafc; color: #1e293b; }
        .misa-sidebar { width: 260px; background: #0f172a; color: #94a3b8; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; cursor: pointer; border-left: 4px solid transparent; transition: 0.2s; }
        .nav-item:hover { background: #1e293b; color: white; }
        .nav-item.active { background: #1e293b; color: #6366f1; border-left-color: #6366f1; }
        .misa-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .btn-primary { background: #6366f1; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 600; transition: 0.2s; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-outline { border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 8px; font-weight: 600; transition: 0.2s; background: white; }
        .btn-outline:hover { background: #f8fafc; }
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        
        /* Search/Selector Styles */
        .search-results-box { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; z-index: 100; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); max-height: 250px; overflow-y: auto; }
        .search-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .search-item:hover { background: #f8fafc; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="misa-sidebar flex flex-col shrink-0">
        <div class="p-6 flex items-center gap-3">
            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg"><i data-lucide="layers"></i></div>
            <div>
                <h1 class="font-bold text-white text-lg leading-none">PT ERP</h1>
                <span class="text-[10px] uppercase tracking-widest text-indigo-400 font-bold">Enterprise</span>
            </div>
        </div>

        <nav class="flex-1 mt-4 overflow-y-auto custom-scroll">
            <div class="px-6 py-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Chính</div>
            <div class="nav-item" id="nav-dashboard" onclick="switchTab('dashboard')"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> Tổng quan</div>
            <div class="nav-item" id="nav-inventory" onclick="switchTab('inventory')"><i data-lucide="package" class="w-5 h-5"></i> Kho hàng</div>
            
            <div class="px-6 py-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Nghiệp vụ</div>
            <div class="nav-item" id="nav-purchasing" onclick="switchTab('purchasing')"><i data-lucide="shopping-cart" class="w-5 h-5"></i> Nhập hàng</div>
            <div class="nav-item" id="nav-sales" onclick="switchTab('sales')"><i data-lucide="banknote" class="w-5 h-5"></i> Bán hàng</div>
            <div class="nav-item" id="nav-partners" onclick="switchTab('partners')"><i data-lucide="users" class="w-5 h-5"></i> Đối tác</div>
            
            <div class="px-6 py-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Hệ thống</div>
            <div class="nav-item" id="nav-settings" onclick="switchTab('settings')"><i data-lucide="settings" class="w-5 h-5"></i> Cấu hình</div>
        </nav>

        <div class="p-6 border-t border-slate-800">
            <div id="live-clock" class="text-xs font-mono text-slate-500"></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0">
        <header class="h-16 bg-white border-b flex items-center justify-between px-8 shrink-0">
            <h2 id="tab-title" class="font-bold text-slate-800 text-lg uppercase tracking-tight">Tổng quan</h2>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="text-xs font-bold text-slate-800" id="header-company">PT GROUP</div>
                </div>
                <div class="w-10 h-10 bg-indigo-100 text-indigo-700 rounded-xl flex items-center justify-center font-bold">AD</div>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-8 custom-scroll"></div>
    </main>

    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm hidden"></div>

    <div id="toast" class="fixed bottom-8 right-8 z-[100] transform translate-y-20 opacity-0 transition-all duration-300">
        <div class="bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3">
            <span id="toast-msg" class="text-sm font-bold"></span>
        </div>
    </div>

    <script>
        // --- State Management ---
        let state = JSON.parse(localStorage.getItem('PT_ERP_DB')) || {
            inventory: [],
            purchases: [],
            sales: [],
            partners: [],
            settings: { companyName: "PT GROUP", font: "'Inter', sans-serif", deleteKey: "1234" }
        };

        let currentTab = 'dashboard';
        let selectedItems = new Set();
        let tempSelected = new Set();

        function saveState() { localStorage.setItem('PT_ERP_DB', JSON.stringify(state)); }

        const formatVND = (v) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(v);

        function showToast(m) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = m;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 2500);
        }

        function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }

        // --- Security ---
        function checkDeleteKey() {
            const input = prompt("Vui lòng nhập mật khẩu để thực hiện thao tác xóa:");
            return input === state.settings.deleteKey;
        }

        // --- Navigation ---
        function switchTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tabId}`)?.classList.add('active');
            renderContent(tabId);
            lucide.createIcons();
        }

        function renderContent(tabId) {
            const container = document.getElementById('content-area');
            const titles = { dashboard: "Tổng quan", inventory: "Kho hàng", purchasing: "Nhập hàng", sales: "Bán hàng", partners: "Đối tác", settings: "Cấu hình" };
            document.getElementById('tab-title').innerText = titles[tabId];

            if(tabId === 'dashboard') {
                const totalVal = state.inventory.reduce((a,c) => a+(c.qty*c.priceBuy), 0);
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="misa-card p-6"><div class="text-[10px] font-bold text-slate-400 uppercase">Mặt hàng</div><div class="text-2xl font-black">${state.inventory.length}</div></div>
                        <div class="misa-card p-6"><div class="text-[10px] font-bold text-slate-400 uppercase">Tồn kho</div><div class="text-2xl font-black">${state.inventory.reduce((a,c)=>a+c.qty,0)}</div></div>
                        <div class="misa-card p-6"><div class="text-[10px] font-bold text-slate-400 uppercase">Giá trị kho</div><div class="text-2xl font-black text-indigo-600">${formatVND(totalVal)}</div></div>
                        <div class="misa-card p-6"><div class="text-[10px] font-bold text-slate-400 uppercase">Đối tác</div><div class="text-2xl font-black">${state.partners.length}</div></div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="exportFullReport()" class="btn-primary flex items-center gap-2"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Xuất báo cáo tổng hợp (Excel)</button>
                    </div>
                `;
            } else if(tabId === 'inventory') {
                container.innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4 w-1/2">
                            <input oninput="searchInv(this.value)" type="text" placeholder="Tìm tên hoặc mã (* lọc nhiều cụm)..." class="w-full p-2 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                            ${selectedItems.size > 0 ? `<button onclick="deleteMultipleItems()" class="btn-outline text-red-500 text-xs shrink-0 flex items-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> Xóa (${selectedItems.size})</button>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="downloadTemplate()" class="btn-outline text-xs">Tải mẫu Excel</button>
                            <label class="btn-outline text-xs cursor-pointer flex items-center gap-1"><i data-lucide="upload" class="w-3 h-3"></i> Nhập Excel<input type="file" class="hidden" onchange="importExcel(this)"></label>
                            <button onclick="openItemModal()" class="btn-primary text-xs">+ Thêm mới</button>
                        </div>
                    </div>
                    <div id="inv-table-container" class="misa-card overflow-hidden">
                        ${renderInvTable(state.inventory)}
                    </div>
                `;
            } else if(tabId === 'purchasing' || tabId === 'sales') {
                const list = tabId === 'purchasing' ? state.purchases : state.sales;
                container.innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-bold">Lịch sử ${tabId==='purchasing'?'Nhập':'Bán'} hàng</h3>
                        <button onclick="openTxModal('${tabId}')" class="btn-primary text-xs">+ Tạo phiếu ${tabId==='purchasing'?'Nhập':'Bán'}</button>
                    </div>
                    <div class="misa-card overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b"><tr class="text-[10px] font-bold text-slate-400">
                                <th class="p-4">MÃ PHIẾU</th><th class="p-4">NGÀY</th><th class="p-4">ĐỐI TÁC</th><th class="p-4 text-right">GIÁ TRỊ</th><th class="p-4"></th>
                            </tr></thead>
                            <tbody>${list.map(t => `<tr class="border-b hover:bg-slate-50"><td class="p-4 font-mono font-bold">${t.id}</td><td class="p-4">${new Date(t.date).toLocaleDateString()}</td><td class="p-4">${t.partner}</td><td class="p-4 text-right font-bold">${formatVND(t.total)}</td><td class="p-4 text-right flex justify-end gap-2">
                                <button onclick="exportTxToExcel('${tabId}','${t.id}')" title="Xuất Excel" class="text-green-600 p-1 hover:bg-green-50 rounded"><i data-lucide="download" class="w-4 h-4"></i></button>
                                <button onclick="deleteTx('${tabId}','${t.id}')" title="Xóa" class="text-red-400 p-1 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                `;
            } else if(tabId === 'partners') {
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-6"><h3 class="font-bold">Danh sách đối tác</h3><button onclick="openPartnerModal()" class="btn-primary text-xs">+ Thêm đối tác</button></div>
                    <div class="misa-card overflow-hidden">
                        <table class="w-full text-left text-sm">
                             <tbody>${state.partners.map(p => `<tr class="border-b"><td class="p-4"><span class="status-pill ${p.type==='ncc'?'bg-orange-100 text-orange-700':'bg-blue-100 text-blue-700'}">${p.type==='ncc'?'NCC':'KH'}</span></td><td class="p-4 font-bold">${p.name}</td><td class="p-4 text-right"><button onclick="deletePartner('${p.name}')" class="text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                `;
            } else if(tabId === 'settings') {
                container.innerHTML = `
                    <div class="max-w-md misa-card p-6">
                        <h4 class="font-bold mb-4 uppercase text-xs">Cấu hình hệ thống</h4>
                        <div class="space-y-4">
                            <div><label class="text-[10px] font-bold text-slate-400 uppercase">Tên công ty</label><input id="set-name" value="${state.settings.companyName}" class="w-full p-2 border rounded-xl text-sm"></div>
                            <div><label class="text-[10px] font-bold text-slate-400 uppercase">Mật khẩu xóa dữ liệu</label><input id="set-key" type="password" value="${state.settings.deleteKey}" class="w-full p-2 border rounded-xl text-sm"></div>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="exportDatabase()" class="btn-outline text-xs">Sao lưu .JSON</button>
                                <label class="btn-outline text-xs text-center cursor-pointer">Phục hồi .JSON<input type="file" class="hidden" onchange="importDatabase(this)"></label>
                            </div>
                            <button onclick="saveSettings()" class="btn-primary w-full">Lưu cấu hình</button>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // --- Inventory Logic ---
        function renderInvTable(data) {
            return `
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b"><tr class="text-[10px] font-bold text-slate-400 uppercase">
                        <th class="p-4 w-10 text-center"><input type="checkbox" onchange="toggleSelectAll(this)" ${selectedItems.size === state.inventory.length && state.inventory.length > 0 ? 'checked' : ''}></th>
                        <th class="p-4">Mã hàng</th><th class="p-4">Tên hàng</th><th class="p-4 text-center">Tồn</th><th class="p-4 text-right">Giá nhập</th><th class="p-4 text-right">Giá bán</th><th class="p-4">Ghi chú</th><th class="p-4"></th>
                    </tr></thead>
                    <tbody>${data.map(i => `<tr class="border-b hover:bg-slate-50 ${selectedItems.has(i.id) ? 'bg-indigo-50' : ''}">
                        <td class="p-4 text-center"><input type="checkbox" onchange="toggleSelectItem('${i.id}')" ${selectedItems.has(i.id) ? 'checked' : ''}></td>
                        <td class="p-4 font-mono text-slate-400">${i.id}</td><td class="p-4 font-bold">${i.name}</td><td class="p-4 text-center font-black ${i.qty<=0?'text-red-500':'text-indigo-600'}">${i.qty}</td><td class="p-4 text-right font-mono">${formatVND(i.priceBuy)}</td><td class="p-4 text-right font-mono text-indigo-700 font-bold">${formatVND(i.priceSell)}</td><td class="p-4 text-xs italic text-slate-500">${i.note||''}</td>
                        <td class="p-4 text-right"><button onclick="openItemModal('${i.id}')" class="text-indigo-500 mr-2"><i data-lucide="edit-3" class="w-4 h-4"></i></button><button onclick="deleteItem('${i.id}')" class="text-red-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                    </tr>`).join('')}</tbody>
                </table>
            `;
        }

        function searchInv(q) {
            const parts = q.toLowerCase().split('*').map(p => p.trim());
            const filtered = state.inventory.filter(i => parts.every(p => 
                i.name.toLowerCase().includes(p) || i.id.toLowerCase().includes(p) || (i.note && i.note.toLowerCase().includes(p))
            ));
            document.getElementById('inv-table-container').innerHTML = renderInvTable(filtered);
            lucide.createIcons();
        }

        function toggleSelectItem(id) {
            if(selectedItems.has(id)) selectedItems.delete(id);
            else selectedItems.add(id);
            renderContent('inventory');
        }

        function toggleSelectAll(el) {
            if(el.checked) state.inventory.forEach(i => selectedItems.add(i.id));
            else selectedItems.clear();
            renderContent('inventory');
        }

        function deleteItem(id) {
            if(checkDeleteKey()) {
                state.inventory = state.inventory.filter(x=>x.id!==id);
                saveState(); renderContent('inventory');
                showToast("Đã xóa mặt hàng.");
            } else { showToast("Sai mật khẩu!"); }
        }

        function deleteMultipleItems() {
            if(checkDeleteKey()) {
                state.inventory = state.inventory.filter(i => !selectedItems.has(i.id));
                selectedItems.clear();
                saveState(); renderContent('inventory');
                showToast("Đã xóa hàng loạt.");
            } else { showToast("Sai mật khẩu!"); }
        }

        // --- Transaction Management ---
        function openTxModal(type) {
            const isP = type === 'purchasing';
            const m = document.getElementById('modal-container');
            const partners = state.partners.filter(p => isP ? p.type === 'ncc' : p.type === 'kh');
            m.innerHTML = `
                <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl p-8 max-h-[95vh] overflow-y-auto custom-scroll">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-black uppercase text-indigo-700">Phiếu ${isP ? 'Nhập kho' : 'Xuất bán'}</h3>
                        <button onclick="closeModal()"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="text-[10px] font-bold uppercase text-slate-400">Đối tác</label>
                            <select id="tx-partner" class="w-full p-2 border rounded-xl text-sm">
                                <option value="Khách lẻ">Chọn đối tác...</option>
                                ${partners.map(p => `<option value="${p.name}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold uppercase text-slate-400">Số phiếu</label>
                            <input id="tx-id" value="${(isP?'PN':'PX')+Date.now().toString().slice(-6)}" class="w-full p-2 border rounded-xl text-sm font-mono">
                        </div>
                    </div>
                    
                    <div class="mb-4 flex gap-2">
                        <button onclick="openProductSelector()" class="btn-outline text-indigo-600 text-xs flex items-center gap-1"><i data-lucide="plus-square" class="w-4 h-4"></i> Chọn nhiều từ kho</button>
                        <button onclick="addTxRow()" class="btn-outline text-xs">+ Thêm dòng trống</button>
                    </div>

                    <table class="w-full text-sm mb-6">
                        <thead class="bg-slate-50 text-left text-[10px] font-bold text-slate-400 uppercase">
                            <tr><th class="p-2">Tên hàng / Mã hàng</th><th class="p-2 w-24">Số lượng</th><th class="p-2 w-36">Đơn giá</th><th class="p-2 w-10"></th></tr>
                        </thead>
                        <tbody id="tx-rows"></tbody>
                    </table>

                    <div class="flex justify-between items-center border-t pt-6">
                        <div class="text-2xl font-black text-indigo-600" id="tx-total-val">0đ</div>
                        <button onclick="submitTx('${type}')" class="btn-primary px-10 py-3 rounded-2xl">Lưu chứng từ</button>
                    </div>
                </div>
            `;
            m.classList.remove('hidden');
            lucide.createIcons();
        }

        function openProductSelector() {
            tempSelected.clear();
            const sel = document.createElement('div');
            sel.id = "product-selector-overlay";
            sel.className = "fixed inset-0 z-[60] bg-slate-900/80 flex items-center justify-center p-10";
            sel.innerHTML = `
                <div class="bg-white w-full max-w-2xl rounded-2xl p-6 flex flex-col h-full max-h-[80vh]">
                    <div class="flex justify-between mb-4">
                        <h4 class="font-bold">Chọn mặt hàng từ kho</h4>
                        <button onclick="document.getElementById('product-selector-overlay').remove()"><i data-lucide="x"></i></button>
                    </div>
                    <input type="text" oninput="searchSelector(this.value)" placeholder="Tìm tên hoặc mã..." class="w-full p-2 border rounded-lg mb-4 outline-none focus:ring-2 focus:ring-indigo-500">
                    <div id="selector-list" class="flex-1 overflow-y-auto custom-scroll border rounded-lg">
                        ${renderSelectorList(state.inventory)}
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button onclick="confirmProductSelection()" class="btn-primary">Xác nhận chọn</button>
                    </div>
                </div>
            `;
            document.body.appendChild(sel);
            lucide.createIcons();
        }

        function renderSelectorList(data) {
            return data.map(i => `
                <label class="flex items-center gap-3 p-3 border-b hover:bg-slate-50 cursor-pointer">
                    <input type="checkbox" onchange="this.checked ? tempSelected.add('${i.id}') : tempSelected.delete('${i.id}')">
                    <div class="flex-1">
                        <div class="font-bold text-sm">${i.name}</div>
                        <div class="text-[10px] text-slate-400">Mã: ${i.id} | Tồn: ${i.qty} | Giá bán: ${formatVND(i.priceSell)}</div>
                    </div>
                </label>
            `).join('');
        }

        function searchSelector(q) {
            const filtered = state.inventory.filter(i => i.name.toLowerCase().includes(q.toLowerCase()) || i.id.toLowerCase().includes(q.toLowerCase()));
            document.getElementById('selector-list').innerHTML = renderSelectorList(filtered);
        }

        function confirmProductSelection() {
            tempSelected.forEach(id => {
                const item = state.inventory.find(x => x.id === id);
                if(item) addTxRow(item);
            });
            tempSelected.clear();
            document.getElementById('product-selector-overlay').remove();
        }

        function addTxRow(item = null) {
            const tr = document.createElement('tr');
            tr.className = 'border-b tx-row-item';
            const isP = document.querySelector('#modal-container h3').innerText.includes('NHẬP');
            tr.innerHTML = `
                <td class="p-2 relative">
                    <input type="text" placeholder="Tìm hàng..." value="${item?item.name:''}" data-id="${item?item.id:''}" oninput="searchRowInput(this)" class="search-input w-full p-2 border rounded-lg text-sm">
                    <div class="search-results-box hidden custom-scroll"></div>
                </td>
                <td class="p-2"><input type="number" value="1" oninput="calcTx()" class="row-q w-full p-2 border rounded-lg text-center font-bold"></td>
                <td class="p-2"><input type="number" value="${item ? (isP?item.priceBuy:item.priceSell) : 0}" oninput="calcTx()" class="row-p w-full p-2 border rounded-lg text-right font-mono"></td>
                <td class="p-2 text-right"><button onclick="this.parentElement.parentElement.remove(); calcTx();" class="text-red-300 hover:text-red-500"><i data-lucide="minus-circle" class="w-4 h-4"></i></button></td>
            `;
            document.getElementById('tx-rows').appendChild(tr);
            lucide.createIcons();
            calcTx();
        }

        function searchRowInput(input) {
            const q = input.value.toLowerCase();
            const box = input.nextElementSibling;
            if(!q) { box.classList.add('hidden'); return; }
            const res = state.inventory.filter(i => i.name.toLowerCase().includes(q) || i.id.toLowerCase().includes(q)).slice(0, 5);
            box.innerHTML = res.map(i => `<div class="p-2 hover:bg-slate-50 cursor-pointer border-b text-xs" onclick="selectRowItem(this, '${i.id}')"><b>${i.name}</b><br><span class="text-[10px] text-slate-400">${i.id} | Tồn: ${i.qty}</span></div>`).join('');
            box.classList.remove('hidden');
        }

        function selectRowItem(el, id) {
            const item = state.inventory.find(x => x.id === id);
            const row = el.closest('tr');
            const inp = row.querySelector('.search-input');
            const isP = document.querySelector('#modal-container h3').innerText.includes('NHẬP');
            inp.value = item.name;
            inp.dataset.id = item.id;
            row.querySelector('.row-p').value = isP ? item.priceBuy : item.priceSell;
            el.parentElement.classList.add('hidden');
            calcTx();
        }

        function calcTx() {
            let total = 0;
            document.querySelectorAll('.tx-row-item').forEach(r => {
                total += (parseFloat(r.querySelector('.row-q').value)||0) * (parseFloat(r.querySelector('.row-p').value)||0);
            });
            document.getElementById('tx-total-val').innerText = formatVND(total);
        }

        function submitTx(type) {
            const isP = type === 'purchasing';
            const items = [];
            let stockError = false;
            let errorMsg = "";

            document.querySelectorAll('.tx-row-item').forEach(r => {
                const id = r.querySelector('.search-input').dataset.id;
                const q = parseFloat(r.querySelector('.row-q').value) || 0;
                const p = parseFloat(r.querySelector('.row-p').value) || 0;
                
                if(id && q > 0) {
                    // Kiểm tra tồn kho cho xuất bán
                    if(!isP) {
                        const inv = state.inventory.find(x => x.id === id);
                        if(!inv || inv.qty < q) {
                            stockError = true;
                            errorMsg += `- [${id}] ${inv ? inv.name : 'Không xác định'} (Yêu cầu: ${q}, Hiện có: ${inv ? inv.qty : 0})\n`;
                        }
                    }
                    items.push({ id, q, p });
                }
            });

            if(!items.length) return showToast("Chưa chọn sản phẩm!");
            
            // Chặn lưu nếu thiếu hàng trong kho
            if(stockError) {
                alert("KHÔNG THỂ XUẤT KHO!\nCác mặt hàng sau không đủ số lượng tồn:\n" + errorMsg);
                return;
            }
            
            const tx = { 
                id: document.getElementById('tx-id').value, 
                partner: document.getElementById('tx-partner').value, 
                date: Date.now(), 
                items, 
                total: items.reduce((a,c)=>a+c.q*c.p,0) 
            };
            
            // Cập nhật số lượng kho
            items.forEach(it => {
                const inv = state.inventory.find(x => x.id === it.id);
                if(inv) inv.qty += isP ? it.q : -it.q;
            });

            if(isP) state.purchases.push(tx); else state.sales.push(tx);
            saveState(); closeModal(); renderContent(type);
            showToast("Đã lưu chứng từ thành công!");
        }

        function deleteTx(type, id) {
            if(checkDeleteKey()) {
                const list = type === 'purchasing' ? state.purchases : state.sales;
                const tx = list.find(x => x.id === id);
                if(tx) {
                    // Hoàn trả số lượng kho khi xóa phiếu
                    tx.items.forEach(it => {
                        const inv = state.inventory.find(x => x.id === it.id);
                        if(inv) inv.qty += (type === 'purchasing' ? -it.q : it.q);
                    });
                    if(type === 'purchasing') state.purchases = state.purchases.filter(x=>x.id!==id);
                    else state.sales = state.sales.filter(x=>x.id!==id);
                    saveState(); renderContent(type);
                    showToast("Đã xóa phiếu.");
                }
            } else { showToast("Sai mật khẩu!"); }
        }

        // --- Excel & Export ---
        function exportFullReport() {
            const invData = state.inventory.map(i => ({ "Mã hàng": i.id, "Tên hàng": i.name, "Tồn kho": i.qty, "Giá nhập": i.priceBuy, "Giá bán": i.priceSell, "Giá trị tồn": i.qty*i.priceBuy }));
            const partnerData = state.partners.map(p => ({ "Loại": p.type==='ncc'?'NCC':'KH', "Tên": p.name }));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(invData), "Ton Kho");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(partnerData), "Doi Tac");
            XLSX.writeFile(wb, `Bao_Cao_Tong_Hop_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function exportTxToExcel(type, id) {
            const list = type === 'purchasing' ? state.purchases : state.sales;
            const tx = list.find(x => x.id === id);
            const data = tx.items.map((it, idx) => {
                const product = state.inventory.find(p => p.id === it.id);
                return {
                    "STT": idx + 1,
                    "Tên hàng": product ? product.name : "N/A",
                    "Mã hàng": it.id,
                    "Số lượng": it.q,
                    "Đơn giá": it.p,
                    "Thành tiền": it.q * it.p
                };
            });
            data.push({ "STT": "TỔNG CỘNG", "Thành tiền": tx.total });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Chi Tiet Phieu");
            XLSX.writeFile(wb, `${tx.id}_${tx.partner}.xlsx`);
        }

        // --- Settings & Database ---
        function saveSettings() {
            state.settings.companyName = document.getElementById('set-name').value;
            state.settings.deleteKey = document.getElementById('set-key').value;
            saveState(); location.reload();
        }

        function exportDatabase() {
            const blob = new Blob([JSON.stringify(state)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `PT_ERP_BACKUP_${new Date().getTime()}.json`; a.click();
        }

        function importDatabase(input) {
            const reader = new FileReader();
            reader.onload = (e) => { 
                try {
                    state = JSON.parse(e.target.result); 
                    saveState(); location.reload(); 
                } catch(err) { showToast("File không đúng định dạng!"); }
            };
            reader.readAsText(input.files[0]);
        }

        // --- Template/Import Core ---
        function downloadTemplate() {
            const ws = XLSX.utils.aoa_to_sheet([["Mã hàng", "Tên hàng", "Số lượng", "Giá nhập", "Giá bán", "Ghi chú"]]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "Mau_Nhap_Du_Lieu_Kho.xlsx");
        }

        function importExcel(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type:'array'});
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                rows.forEach(r => {
                    const id = r["Mã hàng"] || 'IT'+Math.random().toString(36).slice(2,7).toUpperCase();
                    state.inventory.push({ id, name: r["Tên hàng"], qty: parseFloat(r["Số lượng"])||0, priceBuy: parseFloat(r["Giá nhập"])||0, priceSell: parseFloat(r["Giá bán"])||0, note: r["Ghi chú"]||"" });
                });
                saveState(); renderContent('inventory'); showToast("Đã nhập dữ liệu Excel!");
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        // --- Partners ---
        function openPartnerModal() {
            const m = document.getElementById('modal-container');
            m.innerHTML = `<div class="bg-white p-6 rounded-2xl w-80 shadow-2xl">
                <h4 class="font-bold mb-4">Đối tác mới</h4>
                <select id="p-type" class="w-full mb-3 p-2 border rounded-xl text-sm"><option value="ncc">Nhà cung cấp</option><option value="kh">Khách hàng</option></select>
                <input id="p-name" placeholder="Tên đối tác..." class="w-full mb-4 p-2 border rounded-xl text-sm font-bold">
                <button onclick="savePartner()" class="btn-primary w-full py-2">Lưu</button>
            </div>`;
            m.classList.remove('hidden');
        }
        function savePartner() {
            const n = document.getElementById('p-name').value; if(!n) return;
            state.partners.push({ type: document.getElementById('p-type').value, name: n });
            saveState(); closeModal(); renderContent('partners');
        }
        function deletePartner(n) { if(checkDeleteKey()){ state.partners = state.partners.filter(p=>p.name!==n); saveState(); renderContent('partners'); } }

        // --- Item Editor ---
        function openItemModal(id=null) {
            const i = id ? state.inventory.find(x=>x.id===id) : { id: 'IT'+Date.now().toString().slice(-6), name: '', qty: 0, priceBuy: 0, priceSell: 0, note: '' };
            const m = document.getElementById('modal-container');
            m.innerHTML = `<div class="bg-white p-6 rounded-2xl w-96 shadow-2xl">
                <h4 class="font-bold mb-4 uppercase text-sm text-indigo-600">${id?'Cập nhật mặt hàng':'Thêm mặt hàng mới'}</h4>
                <div class="space-y-4">
                    <div><label class="text-[10px] font-bold text-slate-400">Tên mặt hàng</label><input id="m-name" value="${i.name}" class="w-full p-2 border rounded-xl text-sm font-bold"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-slate-400">Số lượng tồn</label><input id="m-qty" type="number" value="${i.qty}" class="w-full p-2 border rounded-xl text-sm"></div>
                        <div><label class="text-[10px] font-bold text-slate-400">Ghi chú</label><input id="m-note" value="${i.note||''}" class="w-full p-2 border rounded-xl text-sm"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-slate-400">Giá nhập</label><input id="m-buy" type="number" value="${i.priceBuy}" class="w-full p-2 border rounded-xl text-sm"></div>
                        <div><label class="text-[10px] font-bold text-slate-400">Giá bán</label><input id="m-sell" type="number" value="${i.priceSell}" class="w-full p-2 border rounded-xl text-sm"></div>
                    </div>
                    <button onclick="saveItem('${id||''}')" class="btn-primary w-full py-2">Lưu dữ liệu</button>
                    <button onclick="closeModal()" class="w-full text-xs text-slate-400 mt-2">Hủy bỏ</button>
                </div>
            </div>`;
            m.classList.remove('hidden');
        }
        function saveItem(oldId) {
            const name = document.getElementById('m-name').value;
            if(!name) return showToast("Vui lòng nhập tên hàng!");
            const obj = { 
                id: oldId || 'IT'+Date.now().toString().slice(-6), 
                name: name, 
                qty: parseFloat(document.getElementById('m-qty').value)||0, 
                priceBuy: parseFloat(document.getElementById('m-buy').value)||0, 
                priceSell: parseFloat(document.getElementById('m-sell').value)||0, 
                note: document.getElementById('m-note').value 
            };
            if(oldId) { 
                const idx = state.inventory.findIndex(x=>x.id===oldId); 
                state.inventory[idx] = obj; 
            } else { 
                state.inventory.push(obj); 
            }
            saveState(); closeModal(); renderContent('inventory');
        }

        window.onload = () => {
            document.getElementById('header-company').innerText = state.settings.companyName;
            switchTab('dashboard');
            setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleString('vi-VN'); }, 1000);
        };
    </script>
</body>
</html>
