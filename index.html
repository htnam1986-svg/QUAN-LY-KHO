<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT Warehouse ERP - Smart Search Doc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .active-link { background: #4f46e5; color: white; transition: all 0.2s ease; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .modal-overlay { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); }
        input[type="checkbox"] { width: 1.1rem; height: 1.1rem; cursor: pointer; accent-color: #4f46e5; }
        
        /* Hiệu ứng danh sách tìm kiếm trong phiếu */
        .search-results-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            margin-top: 0.25rem;
            display: none;
            background: white;
            position: absolute;
            width: 100%;
            z-index: 50;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .search-item:hover { background-color: #f8fafc; cursor: pointer; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 shadow-sm z-20">
        <div class="p-6">
            <div class="flex items-center gap-3 mb-8">
                <div class="bg-indigo-600 p-2.5 rounded-xl text-white shadow-lg">
                    <i data-lucide="package" class="w-6 h-6"></i>
                </div>
                <h1 class="font-bold text-lg tracking-tight">PT ERP PRO</h1>
            </div>
            
            <nav class="space-y-1">
                <a href="#" onclick="switchTab('inventory')" id="nav-inventory" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition-all font-medium">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i> Kho hàng
                </a>
                <a href="#" onclick="switchTab('documents')" id="nav-documents" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition-all font-medium">
                    <i data-lucide="file-text" class="w-5 h-5"></i> Chứng từ
                </a>
                <a href="#" onclick="switchTab('partners')" id="nav-partners" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition-all font-medium">
                    <i data-lucide="users" class="w-5 h-5"></i> Đối tác
                </a>
                <a href="#" onclick="switchTab('reports')" id="nav-reports" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition-all font-medium">
                    <i data-lucide="pie-chart" class="w-5 h-5"></i> Báo cáo
                </a>
                <a href="#" onclick="switchTab('settings')" id="nav-settings" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition-all font-medium">
                    <i data-lucide="settings" class="w-5 h-5"></i> Cấu hình
                </a>
            </nav>
        </div>
        <div class="mt-auto p-6 border-t border-slate-100">
            <div id="live-clock" class="text-[11px] font-bold text-slate-400 tabular-nums uppercase">--:--:--</div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shrink-0 z-10 gap-4">
            <div class="flex items-center gap-6 flex-1 max-w-2xl">
                <h2 id="tab-title" class="text-lg font-bold text-slate-800 whitespace-nowrap">Kho hàng</h2>
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <input type="text" id="main-search" oninput="handleSmartSearch(this.value)" placeholder='Tìm nhanh (ví dụ: Van*DN25)...' class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500">
                </div>
            </div>
            <div class="flex items-center gap-3" id="header-actions"></div>
        </header>

        <section id="content-area" class="flex-1 overflow-auto p-8 custom-scroll bg-[#fcfcfd]">
            <!-- Content render here -->
        </section>
    </main>

    <!-- Modal -->
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
        <div id="modal-content" class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto custom-scroll relative"></div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] pointer-events-none opacity-0 translate-y-5 transition-all">
        <div id="toast-body" class="bg-slate-900 text-white px-6 py-3 rounded-full shadow-lg text-sm font-medium"></div>
    </div>

    <script>
        // --- DATA STATE ---
        let state = JSON.parse(localStorage.getItem('PT_ERP_PRO_STATE')) || {
            inventory: [],
            documents: [],
            partners: [],
            systemPass: '1234'
        };

        const saveState = () => localStorage.setItem('PT_ERP_PRO_STATE', JSON.stringify(state));

        function showToast(msg, success = true) {
            const t = document.getElementById('toast');
            const tb = document.getElementById('toast-body');
            tb.innerText = msg;
            tb.className = `px-6 py-3 rounded-full shadow-lg text-sm font-medium ${success ? 'bg-indigo-600' : 'bg-rose-500'}`;
            t.classList.remove('opacity-0', 'translate-y-5');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-5'), 3000);
        }

        function handleSmartSearch(query) {
            const currentTab = document.querySelector('aside nav a.active-link').id.replace('nav-', '');
            const keywords = query.toLowerCase().split('*').map(k => k.trim()).filter(k => k !== '');
            let targetSelector = '';
            if (currentTab === 'inventory') targetSelector = '#inventory-table-body tr';
            else if (currentTab === 'documents') targetSelector = '#docs-table-body tr';
            else if (currentTab === 'partners') targetSelector = '#partners-table-body tr';
            
            if (!targetSelector) return;
            document.querySelectorAll(targetSelector).forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = (keywords.length === 0 || keywords.every(kw => text.includes(kw))) ? '' : 'none';
            });
        }

        // --- NAVIGATION ---
        function switchTab(tab) {
            document.querySelectorAll('aside nav a').forEach(a => a.classList.remove('active-link'));
            document.getElementById(`nav-${tab}`).classList.add('active-link');
            document.getElementById('tab-title').innerText = 
                tab === 'inventory' ? 'Kho hàng' : 
                tab === 'documents' ? 'Chứng từ' : 
                tab === 'partners' ? 'Đối tác' : 
                tab === 'reports' ? 'Báo cáo' : 'Cấu hình';
            renderContent(tab);
        }

        function renderContent(tab) {
            const area = document.getElementById('content-area');
            const actions = document.getElementById('header-actions');
            actions.innerHTML = '';

            if (tab === 'inventory') {
                actions.innerHTML = `
                    <button id="btn-delete-multi" onclick="deleteMultipleProducts()" class="hidden px-4 py-2 bg-rose-50 text-rose-600 rounded-lg font-bold text-xs hover:bg-rose-100 transition">Xóa đã chọn</button>
                    <label class="px-4 py-2 bg-emerald-50 text-emerald-600 rounded-lg font-bold text-xs hover:bg-emerald-100 transition cursor-pointer flex items-center gap-2">
                        <i data-lucide="file-up" class="w-4 h-4"></i> Nhập Excel
                        <input type="file" accept=".xlsx, .xls" class="hidden" onchange="handleExcelUpload(this)">
                    </label>
                    <button onclick="openProductModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold text-xs hover:bg-indigo-700">+ Thêm hàng</button>
                `;
                area.innerHTML = `
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50 border-b border-slate-200 text-[10px] uppercase text-slate-400 font-bold">
                                    <th class="p-4 w-10 text-center"><input type="checkbox" onchange="toggleSelectAll(this)"></th>
                                    <th class="p-4">Mã hàng / Tên</th>
                                    <th class="p-4 text-center">ĐVT</th>
                                    <th class="p-4 text-right">Tồn kho</th>
                                    <th class="p-4 text-right">Giá bán</th>
                                    <th class="p-4">Ghi chú</th>
                                    <th class="p-4 text-center">Tác vụ</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                                ${state.inventory.map((item) => `
                                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                                        <td class="p-4 text-center"><input type="checkbox" class="product-cb" value="${item.id}" onchange="updateMultiDeleteBtn()"></td>
                                        <td class="p-4">
                                            <div class="font-mono text-[10px] text-indigo-500 font-bold">${item.id}</div>
                                            <div class="font-bold text-slate-700">${item.name}</div>
                                        </td>
                                        <td class="p-4 text-center text-slate-500 text-sm">${item.unit}</td>
                                        <td class="p-4 text-right font-black ${item.qty < 5 ? 'text-rose-500' : 'text-slate-800'}">${item.qty}</td>
                                        <td class="p-4 text-right font-bold text-indigo-600">${new Intl.NumberFormat('vi-VN').format(item.priceSell)}đ</td>
                                        <td class="p-4 text-sm text-slate-400 italic truncate max-w-[150px]">${item.note || ''}</td>
                                        <td class="p-4 text-center">
                                            <div class="flex items-center justify-center gap-2">
                                                <button onclick="openProductModal('${item.id}')" class="p-1.5 hover:bg-indigo-50 text-indigo-600 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                                <button onclick="deleteProduct('${item.id}')" class="p-1.5 hover:bg-rose-50 text-rose-600 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (tab === 'documents') {
                actions.innerHTML = `
                    <button onclick="openDocModal('IMPORT')" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold text-xs">+ Nhập kho</button>
                    <button onclick="openDocModal('EXPORT')" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-bold text-xs">+ Xuất kho</button>
                `;
                area.innerHTML = `
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50 border-b border-slate-200 text-[10px] uppercase text-slate-400 font-bold">
                                    <th class="p-4">Ngày / Loại</th>
                                    <th class="p-4">Đối tác</th>
                                    <th class="p-4">Sản phẩm</th>
                                    <th class="p-4 text-right">SL</th>
                                    <th class="p-4 text-right">Tổng tiền</th>
                                    <th class="p-4 text-center w-20">Tác vụ</th>
                                </tr>
                            </thead>
                            <tbody id="docs-table-body">
                                ${state.documents.map((d, idx) => `
                                    <tr class="border-b border-slate-100 hover:bg-slate-50">
                                        <td class="p-4">
                                            <div class="text-[10px] text-slate-400">${d.date}</div>
                                            <span class="px-2 py-0.5 ${d.type === 'IMPORT' ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'} rounded text-[10px] font-bold uppercase">${d.type === 'IMPORT' ? 'Nhập' : 'Xuất'}</span>
                                        </td>
                                        <td class="p-4 font-bold text-slate-700 text-sm">${d.partner}</td>
                                        <td class="p-4 text-sm text-slate-600">${d.itemName}</td>
                                        <td class="p-4 text-right font-bold">${d.qty}</td>
                                        <td class="p-4 text-right font-bold text-slate-800">${new Intl.NumberFormat('vi-VN').format(d.total)}đ</td>
                                        <td class="p-4 text-center">
                                            <div class="flex items-center justify-center gap-2">
                                                <button onclick="editDocument(${idx})" class="p-1.5 hover:bg-indigo-50 text-indigo-500 rounded-lg"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                                <button onclick="deleteDocument(${idx})" class="p-1.5 hover:bg-rose-50 text-rose-600 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (tab === 'partners') {
                actions.innerHTML = `<button onclick="openPartnerModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold text-xs hover:bg-indigo-700">+ Đối tác</button>`;
                area.innerHTML = `
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50 border-b border-slate-200 text-[10px] uppercase text-slate-400 font-bold">
                                    <th class="p-4">Tên đối tác</th>
                                    <th class="p-4">Loại / MST</th>
                                    <th class="p-4">Số điện thoại</th>
                                    <th class="p-4">Địa chỉ</th>
                                </tr>
                            </thead>
                            <tbody id="partners-table-body">
                                ${state.partners.map(p => `
                                    <tr class="border-b border-slate-100">
                                        <td class="p-4 font-bold text-slate-700">${p.name}</td>
                                        <td class="p-4">
                                            <span class="px-2 py-0.5 bg-slate-100 rounded text-[10px] font-bold text-slate-600 block w-fit mb-1">${p.type}</span>
                                            <div class="text-[11px] font-mono text-indigo-500 font-bold">${p.taxCode || '---'}</div>
                                        </td>
                                        <td class="p-4 text-sm text-slate-600">${p.phone || '---'}</td>
                                        <td class="p-4 text-sm text-slate-500">${p.address || '---'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (tab === 'reports') {
                const revenue = state.documents.filter(d => d.type === 'EXPORT').reduce((acc, curr) => acc + curr.total, 0);
                const importCost = state.documents.filter(d => d.type === 'IMPORT').reduce((acc, curr) => acc + curr.total, 0);
                area.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-3xl border shadow-sm">
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Doanh thu (Xuất)</p>
                            <h3 class="text-2xl font-black text-indigo-600">${new Intl.NumberFormat('vi-VN').format(revenue)}đ</h3>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border shadow-sm">
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Chi phí (Nhập)</p>
                            <h3 class="text-2xl font-black text-rose-500">${new Intl.NumberFormat('vi-VN').format(importCost)}đ</h3>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border shadow-sm">
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Lợi nhuận gộp</p>
                            <h3 class="text-2xl font-black text-emerald-600">${new Intl.NumberFormat('vi-VN').format(revenue - importCost)}đ</h3>
                        </div>
                    </div>
                `;
            } else if (tab === 'settings') {
                area.innerHTML = `
                    <div class="max-w-xl mx-auto bg-white p-8 rounded-3xl border shadow-sm space-y-6">
                        <h3 class="font-bold text-lg">Cấu hình hệ thống</h3>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Mật khẩu mới</label>
                            <input type="password" id="new-sys-pass" class="w-full p-3 bg-slate-50 border rounded-xl" value="${state.systemPass}">
                            <button onclick="updatePassword()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">Cập nhật mật khẩu</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="exportData()" class="p-4 bg-slate-50 border rounded-2xl font-bold text-xs flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> Xuất JSON</button>
                            <label class="p-4 bg-slate-50 border rounded-2xl font-bold text-xs flex items-center justify-center gap-2 cursor-pointer text-center"><i data-lucide="upload" class="w-4 h-4"></i> Nhập JSON<input type="file" class="hidden" onchange="importData(this)"></label>
                        </div>
                        <button onclick="factoryReset()" class="w-full text-rose-500 font-bold text-xs mt-4">Xóa toàn bộ dữ liệu</button>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // --- SMART SEARCH IN MODAL ---
        let selectedProductForDoc = null;

        function handleProductSearchInDoc(q) {
            const resultsBox = document.getElementById('search-results-box');
            if(!q.trim()) { resultsBox.style.display = 'none'; return; }
            
            const filtered = state.inventory.filter(i => i.name.toLowerCase().includes(q.toLowerCase()) || i.id.toLowerCase().includes(q.toLowerCase()));
            
            if(filtered.length === 0) {
                resultsBox.innerHTML = `<div class="p-4 text-sm text-slate-400 italic">Không tìm thấy hàng...</div>`;
            } else {
                resultsBox.innerHTML = filtered.map(i => `
                    <div onclick="selectProductForDoc('${i.id}')" class="search-item p-3 border-b last:border-0">
                        <div class="font-bold text-sm text-slate-700">${i.name}</div>
                        <div class="flex justify-between text-[10px] text-slate-500 font-medium">
                            <span>Mã: ${i.id}</span>
                            <span>Tồn: <b class="${i.qty < 5 ? 'text-rose-500' : 'text-indigo-600'}">${i.qty}</b> ${i.unit}</span>
                        </div>
                    </div>
                `).join('');
            }
            resultsBox.style.display = 'block';
        }

        function selectProductForDoc(id) {
            selectedProductForDoc = state.inventory.find(i => i.id === id);
            document.getElementById('doc-product-search-input').value = selectedProductForDoc.name;
            document.getElementById('search-results-box').style.display = 'none';
            document.getElementById('doc-item-id-hidden').value = id;
            showToast(`Đã chọn: ${selectedProductForDoc.name}`);
        }

        // --- EXCEL UPLOAD ---
        function handleExcelUpload(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);

                    json.forEach(r => {
                        const name = (r['Tên hàng'] || r['Ten hang'] || '').toString().trim();
                        if (name) {
                            const qty = parseFloat(r['Số lượng'] || r['So luong']) || 0;
                            const idx = state.inventory.findIndex(i => i.name.toLowerCase() === name.toLowerCase());
                            if (idx > -1) {
                                state.inventory[idx].qty += qty;
                            } else {
                                state.inventory.push({
                                    id: 'EX' + Math.floor(1000 + Math.random() * 8999),
                                    name: name,
                                    unit: r['Đơn vị'] || r['Don vi'] || 'Cái',
                                    qty: qty,
                                    priceBuy: parseFloat(r['Giá nhập'] || r['Gia nhap'] || 0),
                                    priceSell: parseFloat(r['Giá bán'] || r['Gia ban'] || 0),
                                    note: r['Ghi chú'] || r['Ghi chu'] || ''
                                });
                            }
                        }
                    });
                    saveState(); renderContent('inventory'); showToast("Đã đồng bộ dữ liệu Excel");
                } catch (err) { showToast("Lỗi đọc Excel", false); }
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        // --- INVENTORY LOGIC ---
        function openProductModal(id = null) {
            const p = id ? state.inventory.find(i => i.id === id) : null;
            const mc = document.getElementById('modal-content');
            mc.innerHTML = `
                <div class="p-6 border-b flex justify-between items-center bg-slate-50/50">
                    <h2 class="text-xl font-bold">${id ? 'Cập nhật hàng hóa' : 'Thêm sản phẩm'}</h2>
                    <button onclick="closeModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-8 space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Tên sản phẩm</label>
                        <input type="text" id="p-name" value="${p ? p.name : ''}" class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:border-indigo-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Đơn vị</label>
                            <input type="text" id="p-unit" value="${p ? p.unit : ''}" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Số lượng ban đầu</label>
                            <input type="number" id="p-qty" value="${p ? p.qty : 0}" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Giá nhập</label>
                            <input type="number" id="p-buy" value="${p ? p.priceBuy : 0}" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Giá bán</label>
                            <input type="number" id="p-sell" value="${p ? p.priceSell : 0}" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Ghi chú</label>
                        <textarea id="p-note" class="w-full p-3 bg-slate-50 border rounded-xl h-20">${p ? (p.note || '') : ''}</textarea>
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end gap-3 bg-slate-50/30">
                    <button onclick="closeModal()" class="px-6 py-2.5 font-bold text-slate-400">Hủy</button>
                    <button onclick="saveProduct('${id || ''}')" class="px-8 py-2.5 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">Lưu dữ liệu</button>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
            lucide.createIcons();
        }

        function saveProduct(id) {
            const name = document.getElementById('p-name').value.trim();
            if(!name) return showToast("Vui lòng nhập tên", false);
            
            const data = {
                name,
                unit: document.getElementById('p-unit').value || 'Cái',
                qty: parseFloat(document.getElementById('p-qty').value) || 0,
                priceBuy: parseFloat(document.getElementById('p-buy').value) || 0,
                priceSell: parseFloat(document.getElementById('p-sell').value) || 0,
                note: document.getElementById('p-note').value
            };

            if (id) {
                const idx = state.inventory.findIndex(i => i.id === id);
                state.inventory[idx] = { ...state.inventory[idx], ...data };
            } else {
                state.inventory.push({ id: 'SP' + Math.floor(Math.random() * 9999), ...data });
            }
            saveState(); closeModal(); renderContent('inventory'); showToast("Cập nhật kho thành công");
        }

        function deleteProduct(id) {
            if(confirm("Xóa mặt hàng này?")) {
                state.inventory = state.inventory.filter(i => i.id !== id);
                saveState(); renderContent('inventory'); showToast("Đã xóa");
            }
        }

        function toggleSelectAll(master) {
            document.querySelectorAll('.product-cb').forEach(cb => cb.checked = master.checked);
            updateMultiDeleteBtn();
        }

        function updateMultiDeleteBtn() {
            const checked = document.querySelectorAll('.product-cb:checked').length;
            const btn = document.getElementById('btn-delete-multi');
            if(checked > 0) btn.classList.remove('hidden');
            else btn.classList.add('hidden');
        }

        function deleteMultipleProducts() {
            const ids = Array.from(document.querySelectorAll('.product-cb:checked')).map(cb => cb.value);
            if(confirm(`Xóa ${ids.length} mặt hàng đã chọn?`)) {
                state.inventory = state.inventory.filter(i => !ids.includes(i.id));
                saveState(); renderContent('inventory'); showToast(`Đã xóa ${ids.length} mặt hàng`);
            }
        }

        // --- DOCUMENTS LOGIC ---
        function openDocModal(type) {
            selectedProductForDoc = null;
            const mc = document.getElementById('modal-content');
            mc.innerHTML = `
                <div class="p-6 border-b flex justify-between items-center ${type === 'IMPORT' ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'}">
                    <h2 class="text-xl font-bold">${type === 'IMPORT' ? 'Phiếu Nhập Kho' : 'Phiếu Xuất Kho'}</h2>
                    <button onclick="closeModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-8 space-y-5">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Đối tác</label>
                        <select id="doc-partner" class="w-full p-3 bg-slate-50 border rounded-xl">
                            ${state.partners.length ? state.partners.map(p => `<option value="${p.name}">${p.name}</option>`).join('') : '<option value="Khách lẻ">Khách vãng lai</option>'}
                        </select>
                    </div>
                    
                    <div class="relative">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Tìm sản phẩm</label>
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input type="text" id="doc-product-search-input" oninput="handleProductSearchInDoc(this.value)" placeholder="Gõ tên hoặc mã hàng..." class="w-full pl-10 pr-4 py-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500/20">
                            <input type="hidden" id="doc-item-id-hidden">
                        </div>
                        <div id="search-results-box" class="search-results-container custom-scroll shadow-2xl"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Số lượng</label>
                            <input type="number" id="doc-qty" value="1" class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500/20">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Ghi chú phiếu</label>
                            <input type="text" id="doc-note" class="w-full p-3 bg-slate-50 border rounded-xl outline-none" placeholder="...">
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end gap-3 bg-slate-50/30">
                    <button onclick="closeModal()" class="px-6 py-2.5 font-bold text-slate-400">Đóng</button>
                    <button onclick="saveDocument('${type}')" class="px-8 py-2.5 ${type === 'IMPORT' ? 'bg-emerald-600' : 'bg-rose-600'} text-white font-bold rounded-xl shadow-lg">Lưu phiếu</button>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
            lucide.createIcons();
        }

        function saveDocument(type) {
            const itemId = document.getElementById('doc-item-id-hidden').value;
            const qty = parseFloat(document.getElementById('doc-qty').value) || 0;
            const itemIdx = state.inventory.findIndex(i => i.id === itemId);
            
            if (itemIdx === -1) return showToast("Vui lòng chọn hàng hóa!", false);
            if (qty <= 0) return showToast("Số lượng không hợp lệ", false);
            
            const item = state.inventory[itemIdx];
            if (type === 'EXPORT' && item.qty < qty) return showToast("Kho không đủ hàng!", false);

            const total = qty * (type === 'IMPORT' ? item.priceBuy : item.priceSell);
            state.documents.push({
                date: new Date().toLocaleString('vi-VN'),
                type,
                partner: document.getElementById('doc-partner').value,
                itemName: item.name,
                itemId: itemId,
                qty,
                total,
                note: document.getElementById('doc-note').value
            });

            if (type === 'IMPORT') state.inventory[itemIdx].qty += qty;
            else state.inventory[itemIdx].qty -= qty;

            saveState(); closeModal(); renderContent('documents'); showToast("Đã lập phiếu thành công");
        }

        function deleteDocument(idx) {
            if(confirm("Xóa chứng từ này? Lưu ý: Không hoàn lại kho tự động.")) {
                state.documents.splice(idx, 1);
                saveState(); renderContent('documents'); showToast("Đã xóa chứng từ");
            }
        }

        function editDocument(idx) {
            const d = state.documents[idx];
            const mc = document.getElementById('modal-content');
            mc.innerHTML = `
                <div class="p-6 border-b flex justify-between items-center bg-indigo-50">
                    <h2 class="text-xl font-bold">Chỉnh sửa phiếu</h2>
                    <button onclick="closeModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-8 space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Đối tác</label>
                        <select id="edoc-partner" class="w-full p-3 bg-slate-50 border rounded-xl">
                            ${state.partners.map(p => `<option value="${p.name}" ${p.name === d.partner ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Số lượng</label>
                            <input type="number" id="edoc-qty" value="${d.qty}" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Ghi chú</label>
                            <input type="text" id="edoc-note" value="${d.note || ''}" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end gap-3 bg-slate-50/30">
                    <button onclick="closeModal()" class="px-6 py-2.5 font-bold text-slate-400">Đóng</button>
                    <button onclick="updateDocument(${idx})" class="px-8 py-2.5 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">Cập nhật</button>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
            lucide.createIcons();
        }

        function updateDocument(idx) {
            state.documents[idx].partner = document.getElementById('edoc-partner').value;
            state.documents[idx].qty = parseFloat(document.getElementById('edoc-qty').value) || 0;
            state.documents[idx].note = document.getElementById('edoc-note').value;
            saveState(); closeModal(); renderContent('documents'); showToast("Đã lưu chỉnh sửa");
        }

        // --- PARTNERS ---
        function openPartnerModal() {
            const mc = document.getElementById('modal-content');
            mc.innerHTML = `
                <div class="p-6 border-b flex justify-between items-center bg-slate-50/50">
                    <h2 class="text-xl font-bold">Thêm đối tác</h2>
                    <button onclick="closeModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-8 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Loại</label>
                            <select id="pt-type" class="w-full p-3 bg-slate-50 border rounded-xl"><option>Khách hàng</option><option>Nhà cung cấp</option></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Tên đối tác</label>
                            <input type="text" id="pt-name" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Mã số thuế</label>
                            <input type="text" id="pt-tax" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">SĐT</label>
                            <input type="text" id="pt-phone" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Địa chỉ</label>
                        <textarea id="pt-address" class="w-full p-3 bg-slate-50 border rounded-xl h-20"></textarea>
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end gap-3 bg-slate-50/30">
                    <button onclick="closeModal()" class="px-6 py-2.5 font-bold text-slate-400">Đóng</button>
                    <button onclick="savePartner()" class="px-8 py-2.5 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">Lưu lại</button>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
            lucide.createIcons();
        }

        function savePartner() {
            const name = document.getElementById('pt-name').value.trim();
            if(!name) return showToast("Vui lòng nhập tên", false);
            state.partners.push({
                name, type: document.getElementById('pt-type').value,
                taxCode: document.getElementById('pt-tax').value,
                phone: document.getElementById('pt-phone').value,
                address: document.getElementById('pt-address').value
            });
            saveState(); closeModal(); renderContent('partners'); showToast("Đã lưu đối tác");
        }

        // --- SYSTEM ---
        function updatePassword() {
            state.systemPass = document.getElementById('new-sys-pass').value;
            saveState(); showToast("Bảo mật đã cập nhật");
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `ERP_PRO_BACKUP_${Date.now()}.json`; a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    state = JSON.parse(e.target.result);
                    saveState(); location.reload();
                } catch(err) { showToast("File không hợp lệ", false); }
            };
            reader.readAsText(input.files[0]);
        }

        function factoryReset() {
            if(confirm("BẠN CÓ CHẮC MUỐN XÓA TẤT CẢ DỮ LIỆU?")) { localStorage.removeItem('PT_ERP_PRO_STATE'); location.reload(); }
        }

        function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }

        window.onload = () => {
            switchTab('inventory');
            setInterval(() => {
                document.getElementById('live-clock').innerText = new Date().toLocaleString('vi-VN');
            }, 1000);
        };
    </script>
</body>
</html>
